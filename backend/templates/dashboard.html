<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zinnia Axion - {{ user_id }}</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
    background: #f7f9fc; color: #0f172a;
    padding: 24px 36px;
    line-height: 1.5;
  }
  h1 {
    font-size: 1.4rem; font-weight: 700; color: #0f172a;
    letter-spacing: -0.3px;
  }
  .metrics {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 16px; margin-bottom: 24px;
  }
  .card {
    background: #ffffff; border-radius: 10px; padding: 18px 22px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
    transition: box-shadow 0.15s;
  }
  .card:hover {
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.06), 0 2px 4px -2px rgba(0,0,0,0.03);
  }
  .card-label {
    font-size: 0.68rem; color: #64748b;
    text-transform: uppercase; letter-spacing: 1px; font-weight: 600;
  }
  .card-value { font-size: 1.6rem; font-weight: 700; margin-top: 6px; }
  .card-sub { font-size: 0.82rem; color: #94a3b8; margin-top: 2px; }
  .green { color: #059669; }
  .red { color: #dc2626; }
  .neutral { color: #0f172a; }
  .row2 {
    display: grid; grid-template-columns: 2fr 5fr;
    gap: 16px; margin-bottom: 24px;
  }
  .chart-box {
    background: #ffffff; border-radius: 10px; padding: 20px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
  }
  .chart-box.full { margin-bottom: 24px; }
  .chart-title {
    font-size: 0.7rem; color: #64748b; margin-bottom: 14px;
    text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600;
  }
  canvas { max-height: 280px; }
  #appChart { max-height: none; }
  .no-data {
    text-align: center; padding: 80px 20px; color: #94a3b8;
    font-size: 1rem;
  }
  .footer {
    text-align: center; color: #94a3b8; font-size: 0.72rem;
    margin-top: 28px; padding-top: 16px;
    border-top: 1px solid #e2e8f0;
  }
  .refresh-bar {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px;
  }
  .refresh-btn {
    background: #1e40af; color: #ffffff;
    border: none; padding: 7px 18px;
    border-radius: 8px; cursor: pointer;
    font-size: 0.8rem; font-weight: 600;
    box-shadow: 0 1px 2px rgba(30,64,175,0.15);
    transition: all 0.15s;
  }
  .refresh-btn:hover {
    background: #1e3a8a;
    box-shadow: 0 2px 4px rgba(30,64,175,0.22);
  }
  @media (max-width: 768px) {
    body { padding: 16px; }
    .metrics { grid-template-columns: 1fr; }
    .row2 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="refresh-bar">
  <h1>Zinnia Axion - {{ user_id }}</h1>
  <button class="refresh-btn" onclick="location.reload()">Refresh</button>
</div>

<div id="content"></div>
<div class="footer">Only interaction counts are recorded - no keystroke content is ever captured.</div>

<script>
const USER_ID = "{{ user_id }}";
const API = window.location.origin;

function fmt(sec) {
  sec = Math.round(sec);
  if (sec < 60) return sec + "s";
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  let parts = [];
  if (h) parts.push(h + "h");
  if (m) parts.push(m + "m");
  if (s && !h) parts.push(s + "s");
  return parts.join(" ");
}

async function fetchJSON(path) {
  const sep = path.includes("?") ? "&" : "?";
  const url = API + path + sep + "user_id=" + encodeURIComponent(USER_ID);
  const resp = await fetch(url);
  return resp.json();
}

async function load() {
  const el = document.getElementById("content");
  try {
    const [summary, apps, daily] = await Promise.all([
      fetchJSON("/summary/today"),
      fetchJSON("/apps"),
      fetchJSON("/daily?days=7"),
    ]);

    const total = summary.total_seconds || 0;
    if (total === 0) {
      el.innerHTML = '<div class="no-data">No data for today yet. Make sure Zinnia Axion Agent is running.</div>';
      return;
    }

    const prod = summary.productive || 0;
    const nprod = summary.non_productive || 0;
    const prodPct = total ? (prod / total * 100).toFixed(1) : "0.0";
    const nprodPct = total ? (nprod / total * 100).toFixed(1) : "0.0";

    el.innerHTML = `
      <div class="metrics">
        <div class="card">
          <div class="card-label">Productive</div>
          <div class="card-value green">${fmt(prod)}</div>
          <div class="card-sub">${prodPct}%</div>
        </div>
        <div class="card">
          <div class="card-label">Non-Productive</div>
          <div class="card-value red">${fmt(nprod)}</div>
          <div class="card-sub">${nprodPct}%</div>
        </div>
        <div class="card">
          <div class="card-label">Total Tracked</div>
          <div class="card-value neutral">${fmt(total)}</div>
          <div class="card-sub">${summary.total_buckets || 0} buckets</div>
        </div>
      </div>

      <div class="row2">
        <div class="chart-box">
          <div class="chart-title">State Distribution</div>
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">Daily Trend - last 7 days</div>
          <canvas id="areaChart"></canvas>
        </div>
      </div>

      <div class="chart-box full">
        <div class="chart-title">Productive vs Non-Productive - last 7 days</div>
        <canvas id="lineChart"></canvas>
      </div>

      <div class="chart-box full">
        <div class="chart-title">App Breakdown</div>
        <canvas id="appChart"></canvas>
      </div>
    `;

    // State Distribution - horizontal bar
    new Chart(document.getElementById("barChart"), {
      type: "bar",
      data: {
        labels: ["Productive", "Non-Productive"],
        datasets: [{
          data: [parseFloat(prodPct), parseFloat(nprodPct)],
          backgroundColor: ["#059669", "#dc2626"],
          borderRadius: 4,
        }],
      },
      options: {
        indexAxis: "y",
        responsive: true,
        scales: {
          x: { max: 110, ticks: { display: false }, grid: { display: false }, border: { display: false } },
          y: { ticks: { color: "#64748b", font: { size: 13, family: "system-ui, sans-serif" } }, grid: { display: false }, border: { display: false } },
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ctx.raw.toFixed(1) + "%" } },
        },
      },
      plugins: [{
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          chart.data.datasets[0].data.forEach((val, i) => {
            const meta = chart.getDatasetMeta(0).data[i];
            ctx.fillStyle = "#334155";
            ctx.font = "600 13px system-ui, sans-serif";
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";
            ctx.fillText(val.toFixed(1) + "%", meta.x + 8, meta.y);
          });
        }
      }],
    });

    // Stacked area chart - 7 day trend
    const dates = daily.map(d => d.date);
    const prodMins = daily.map(d => Math.round((d.productive || 0) / 60 * 10) / 10);
    const nprodMins = daily.map(d => Math.round((d.non_productive || 0) / 60 * 10) / 10);

    new Chart(document.getElementById("areaChart"), {
      type: "line",
      data: {
        labels: dates,
        datasets: [
          { label: "Productive", data: prodMins, borderColor: "#059669", backgroundColor: "rgba(5,150,105,0.12)", fill: true, tension: 0.3, pointRadius: 0, order: 2 },
          { label: "Non-Productive", data: nprodMins, borderColor: "#dc2626", backgroundColor: "rgba(220,38,38,0.10)", fill: true, tension: 0.3, pointRadius: 0, order: 1 },
        ],
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { color: "#94a3b8", font: { family: "system-ui" } }, grid: { color: "#f1f5f9" } },
          y: { ticks: { color: "#94a3b8", font: { family: "system-ui" }, callback: v => v + "m" }, grid: { color: "#f1f5f9" } },
        },
        plugins: { legend: { position: "top", align: "end", labels: { color: "#64748b", usePointStyle: true, pointStyle: "circle", font: { family: "system-ui" } } } },
      },
    });

    // Line chart with markers - 7 day trend
    new Chart(document.getElementById("lineChart"), {
      type: "line",
      data: {
        labels: dates,
        datasets: [
          { label: "Productive", data: prodMins, borderColor: "#059669", backgroundColor: "#059669", pointRadius: 4, pointHoverRadius: 6, tension: 0.3, fill: false, borderWidth: 2 },
          { label: "Non-Productive", data: nprodMins, borderColor: "#dc2626", backgroundColor: "#dc2626", pointRadius: 4, pointHoverRadius: 6, tension: 0.3, fill: false, borderWidth: 2 },
        ],
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { color: "#94a3b8", font: { family: "system-ui" } }, grid: { color: "#f1f5f9" } },
          y: { ticks: { color: "#94a3b8", font: { family: "system-ui" }, callback: v => v + "m" }, grid: { color: "#f1f5f9" } },
        },
        plugins: { legend: { position: "top", align: "end", labels: { color: "#64748b", usePointStyle: true, pointStyle: "circle", font: { family: "system-ui" } } } },
      },
    });

    // App breakdown - stacked horizontal bar
    if (apps && apps.length > 0) {
      const sorted = apps.slice().sort((a, b) => b.total_seconds - a.total_seconds);
      const appLabels = sorted.map(a => a.app_name);
      const appProd = sorted.map(a => (a.states && a.states.productive) || 0);
      const appNprod = sorted.map(a => (a.states && a.states.non_productive) || 0);

      const appChartEl = document.getElementById("appChart");
      appChartEl.parentElement.style.height = Math.max(200, sorted.length * 30 + 60) + "px";

      new Chart(appChartEl, {
        type: "bar",
        data: {
          labels: appLabels,
          datasets: [
            { label: "Productive", data: appProd, backgroundColor: "#059669", borderRadius: 2 },
            { label: "Non-Productive", data: appNprod, backgroundColor: "#dc2626", borderRadius: 2 },
          ],
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true, ticks: { color: "#94a3b8", font: { family: "system-ui" }, callback: v => fmt(v) }, grid: { color: "#f1f5f9" } },
            y: { stacked: true, ticks: { color: "#64748b", font: { family: "system-ui" } }, grid: { display: false } },
          },
          plugins: {
            legend: { position: "top", align: "end", labels: { color: "#64748b", usePointStyle: true, pointStyle: "circle", font: { family: "system-ui" } } },
            tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + fmt(ctx.raw) } },
          },
        },
      });
    }

  } catch (err) {
    el.innerHTML = '<div class="no-data">Could not load data. Is the backend running?</div>';
    console.error(err);
  }
}

load();
setInterval(() => location.reload(), 30000);
</script>
</body>
</html>
