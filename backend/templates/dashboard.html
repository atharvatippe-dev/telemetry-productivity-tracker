<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Productivity Tracker - {{ user_id }}</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: #0e1117; color: #fafafa;
    padding: 24px 32px;
  }
  h1 { font-size: 1.6rem; font-weight: 600; margin-bottom: 20px; }
  .metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
  .card {
    background: #1a1d23; border-radius: 10px; padding: 18px 20px;
    border: 1px solid #2a2d35;
  }
  .card-label { font-size: 0.82rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }
  .card-value { font-size: 1.5rem; font-weight: 700; margin-top: 4px; }
  .card-sub { font-size: 0.85rem; color: #6b7280; margin-top: 2px; }
  .green { color: #22c55e; }
  .red { color: #ef4444; }
  .white { color: #fafafa; }
  .row2 { display: grid; grid-template-columns: 2fr 5fr; gap: 20px; margin-bottom: 24px; }
  .chart-box {
    background: #1a1d23; border-radius: 10px; padding: 18px;
    border: 1px solid #2a2d35;
  }
  .chart-box.full { margin-bottom: 24px; }
  .chart-title { font-size: 0.85rem; color: #9ca3af; margin-bottom: 12px; }
  canvas { max-height: 280px; }
  #appChart { max-height: none; }
  .no-data {
    text-align: center; padding: 80px 20px; color: #6b7280;
    font-size: 1.1rem;
  }
  .footer { text-align: center; color: #4b5563; font-size: 0.78rem; margin-top: 24px; }
  .refresh-bar {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px;
  }
  .refresh-btn {
    background: #2a2d35; color: #9ca3af; border: 1px solid #3a3d45;
    padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.82rem;
  }
  .refresh-btn:hover { background: #3a3d45; color: #fafafa; }
  @media (max-width: 768px) {
    .metrics { grid-template-columns: 1fr; }
    .row2 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="refresh-bar">
  <h1>Productivity Tracker - {{ user_id }}</h1>
  <button class="refresh-btn" onclick="location.reload()">Refresh</button>
</div>

<div id="content"></div>
<div class="footer">Only interaction counts are recorded - no keystroke content is ever captured.</div>

<script>
const USER_ID = "{{ user_id }}";
const API = window.location.origin;

function fmt(sec) {
  sec = Math.round(sec);
  if (sec < 60) return sec + "s";
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  let parts = [];
  if (h) parts.push(h + "h");
  if (m) parts.push(m + "m");
  if (s && !h) parts.push(s + "s");
  return parts.join(" ");
}

async function fetchJSON(path) {
  const sep = path.includes("?") ? "&" : "?";
  const url = API + path + sep + "user_id=" + encodeURIComponent(USER_ID);
  const resp = await fetch(url);
  return resp.json();
}

async function load() {
  const el = document.getElementById("content");
  try {
    const [summary, apps, daily] = await Promise.all([
      fetchJSON("/summary/today"),
      fetchJSON("/apps"),
      fetchJSON("/daily?days=7"),
    ]);

    const total = summary.total_seconds || 0;
    if (total === 0) {
      el.innerHTML = '<div class="no-data">No data for today yet. Make sure the tracker is running.</div>';
      return;
    }

    const prod = summary.productive || 0;
    const nprod = summary.non_productive || 0;
    const prodPct = total ? (prod / total * 100).toFixed(1) : "0.0";
    const nprodPct = total ? (nprod / total * 100).toFixed(1) : "0.0";

    el.innerHTML = `
      <div class="metrics">
        <div class="card">
          <div class="card-label">Productive</div>
          <div class="card-value green">${fmt(prod)}</div>
          <div class="card-sub">${prodPct}%</div>
        </div>
        <div class="card">
          <div class="card-label">Non-Productive</div>
          <div class="card-value red">${fmt(nprod)}</div>
          <div class="card-sub">${nprodPct}%</div>
        </div>
        <div class="card">
          <div class="card-label">Total Tracked</div>
          <div class="card-value white">${fmt(total)}</div>
          <div class="card-sub">${summary.total_buckets || 0} buckets</div>
        </div>
      </div>

      <div class="row2">
        <div class="chart-box">
          <div class="chart-title">State Distribution</div>
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">Daily Trend - last 7 days</div>
          <canvas id="areaChart"></canvas>
        </div>
      </div>

      <div class="chart-box full">
        <div class="chart-title">Productive vs Non-Productive - last 7 days</div>
        <canvas id="lineChart"></canvas>
      </div>

      <div class="chart-box full">
        <div class="chart-title">App Breakdown</div>
        <canvas id="appChart"></canvas>
      </div>
    `;

    // State Distribution - horizontal bar
    new Chart(document.getElementById("barChart"), {
      type: "bar",
      data: {
        labels: ["Productive", "Non-Productive"],
        datasets: [{
          data: [parseFloat(prodPct), parseFloat(nprodPct)],
          backgroundColor: ["#22c55e", "#ef4444"],
          borderRadius: 4,
        }],
      },
      options: {
        indexAxis: "y",
        responsive: true,
        scales: {
          x: { max: 110, ticks: { display: false }, grid: { display: false }, border: { display: false } },
          y: { ticks: { color: "#9ca3af", font: { size: 13 } }, grid: { display: false }, border: { display: false } },
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ctx.raw.toFixed(1) + "%" } },
        },
      },
      plugins: [{
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          chart.data.datasets[0].data.forEach((val, i) => {
            const meta = chart.getDatasetMeta(0).data[i];
            ctx.fillStyle = "#fafafa";
            ctx.font = "bold 13px Segoe UI, sans-serif";
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";
            ctx.fillText(val.toFixed(1) + "%", meta.x + 8, meta.y);
          });
        }
      }],
    });

    // Stacked area chart - 7 day trend
    const dates = daily.map(d => d.date);
    const prodMins = daily.map(d => Math.round((d.productive || 0) / 60 * 10) / 10);
    const nprodMins = daily.map(d => Math.round((d.non_productive || 0) / 60 * 10) / 10);

    new Chart(document.getElementById("areaChart"), {
      type: "line",
      data: {
        labels: dates,
        datasets: [
          { label: "Productive", data: prodMins, borderColor: "#22c55e", backgroundColor: "rgba(34,197,94,0.35)", fill: true, tension: 0.3, pointRadius: 0, order: 2 },
          { label: "Non-Productive", data: nprodMins, borderColor: "#ef4444", backgroundColor: "rgba(239,68,68,0.55)", fill: true, tension: 0.3, pointRadius: 0, order: 1 },
        ],
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { color: "#6b7280" }, grid: { color: "#2a2d35" } },
          y: { ticks: { color: "#6b7280", callback: v => v + "m" }, grid: { color: "#2a2d35" } },
        },
        plugins: { legend: { position: "top", align: "end", labels: { color: "#9ca3af", usePointStyle: true, pointStyle: "circle" } } },
      },
    });

    // Line chart with markers - 7 day trend
    new Chart(document.getElementById("lineChart"), {
      type: "line",
      data: {
        labels: dates,
        datasets: [
          { label: "Productive", data: prodMins, borderColor: "#22c55e", backgroundColor: "#22c55e", pointRadius: 5, pointHoverRadius: 7, tension: 0.3, fill: false },
          { label: "Non-Productive", data: nprodMins, borderColor: "#ef4444", backgroundColor: "#ef4444", pointRadius: 5, pointHoverRadius: 7, tension: 0.3, fill: false },
        ],
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { color: "#6b7280" }, grid: { color: "#2a2d35" } },
          y: { ticks: { color: "#6b7280", callback: v => v + "m" }, grid: { color: "#2a2d35" } },
        },
        plugins: { legend: { position: "top", align: "end", labels: { color: "#9ca3af", usePointStyle: true, pointStyle: "circle" } } },
      },
    });

    // App breakdown - stacked horizontal bar
    if (apps && apps.length > 0) {
      const sorted = apps.slice().sort((a, b) => b.total_seconds - a.total_seconds);
      const appLabels = sorted.map(a => a.app_name);
      const appProd = sorted.map(a => (a.states && a.states.productive) || 0);
      const appNprod = sorted.map(a => (a.states && a.states.non_productive) || 0);

      const appChartEl = document.getElementById("appChart");
      appChartEl.parentElement.style.height = Math.max(200, sorted.length * 30 + 60) + "px";

      new Chart(appChartEl, {
        type: "bar",
        data: {
          labels: appLabels,
          datasets: [
            { label: "Productive", data: appProd, backgroundColor: "#22c55e" },
            { label: "Non-Productive", data: appNprod, backgroundColor: "#ef4444" },
          ],
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true, ticks: { color: "#6b7280", callback: v => fmt(v) }, grid: { color: "#2a2d35" } },
            y: { stacked: true, ticks: { color: "#9ca3af" }, grid: { display: false } },
          },
          plugins: {
            legend: { position: "top", align: "end", labels: { color: "#9ca3af", usePointStyle: true, pointStyle: "circle" } },
            tooltip: { callbacks: { label: ctx => ctx.dataset.label + ": " + fmt(ctx.raw) } },
          },
        },
      });
    }

  } catch (err) {
    el.innerHTML = '<div class="no-data">Could not load data. Is the backend running?</div>';
    console.error(err);
  }
}

load();
setInterval(() => location.reload(), 30000);
</script>
</body>
</html>
